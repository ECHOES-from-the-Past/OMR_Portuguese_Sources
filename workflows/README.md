# Workflows

## BGRemoval Workflow

**Summary:** This workflow allows to save time in the Pixel classification part of the OMR

**Workflow file:** [BGRemoval.json](./BGRemoval.json)

It uses the `Background Removal` job to obtain a foreground layer—which would include all the foreground pixels belonging to music symbols, staff lines, text, images, etc.—and then use Pixel to cut and paste the elements of this layer into the appropriate music symbols, staff lines, and text layers.

The foreground layer obtained by the `Background Removal` job is given by its output port `RGBA PNG image`. This output port can be connected to one of the layer (optional) input ports in Pixel (e.g.,music symbol layer). 
The remaining input layers of Pixel (e.g., staff lines and text) should be connected to the (optional) `Empty Layer` output port from the `Background Removal` job. Then one can use the cut & paste tools from Pixel to move the pixels from the foreground layer into the appropriate layer (e.g., cut them from the music symbol layer to paste them in the appropriate staff lines or text layers).

**Important note:** We always use the `PNG (RGB)` job to process the image at the very beginning.

### Screenshot of workflow
![BGRemoval](./images/BGRemoval.png)

### Screenshot of workflow with annotated for ports
![BGRemoval - annotated](./images/BGRemoval%20-%20annotated.png)

---

## AutomatPixelClassif Workflow

**Summary:** This workflow automatically performs document analysis (pixel classification of the image into the various layers of music symbols, staff lines, text, and background) and then allows the user to fix the results in Pixel. The results can be saved with a label of the folio being processed (this is achieved by using the `labeler` job and set its settings to the label one wants to use).

**Workflow file:** [AutomatPixelClassif.json](./AutomatPixelClassif.json)

### Screenshot of workflow
![AutomatPixelClassif](./images/AutomatPixelClassif.png)

---

## IC Workflow

**Summary:** This workflow receives an image and its music symbol layer to be used to classify the music symbosl in the image using the `Interactive Classifier` (IC) job. 

**Workflow file:** [IC.json](./IC.json)

The IC job here has three outputs: 
- *training data* (optional), to be used for the automatic classification of the music symbols of other images in the future
- *classified glyphs* (required), to be further processed later (with the `heuristic pitch finding` and `mei encoding` jobs)
- and the *class names* (optional), to be used later for the MEI Mapping CSV file so that these classes of glyphs are converted into the correct MEI encoding

**Important notes:**
This workflow in particular was used for **generating the _training data_ and _final class names_** for **Aquitanian** music symbols.

1. Regarding the part of using it for **Aquitanian** music symbols:

   As one sees that the `Interactive Classifier` job is directly preceded by the `CC Analysis` job, and there is no `Diagonal Neume Splitting` job in between, which we usually use for square notation to divide complex neumes into their neume components and have less glyph classes.
   
2. Regarding the part of using it for **generating the training data and final class names** for the music symbols:

   **WE DID NOT USE THIS WORKFLOW TO GET THE CLASSIFIED GLYPHS OF THE PAGE TO CONTINUE DOWN THE WORKFLOW AND GET THE MEI OF THE IMAGE.**
   For the **training data** it is not important if we previosly divide the music layer into columns or not, but this is very important for the **classified glyphs data**. Moreover, if we are using the original image as input of the `Interactive Classifier` job, one needs to use the **original** music symbol layer rather than the one divided into columns. If, on the other hand, one wants to use the music symbol layer **already splitted into columns**, then one cannot use the original image as input for the IC (as this one is not splitted into columns), so the only option is to use the **same splitted music symbol layer** as the "input image".



### Screenshot of workflow
![IC](./images/IC.png)

---

## End2End Workflow

**Summary:** This workflow starts with the original music symbol, staff, and text layers of a page (which can be generated by using [AutomatPixelClassif Workflow](#automatpixelclassif-workflow)).

**Workflow file:** [End2End.json](./End2End.json)

### Screenshot of workflow
![End2End](./images/End2End.png)


---

## Classified Glyphs to MEI Encoding Workflow

**Summary:** This workflow is similar to the [End2End Workflow](#endtoend-workflow), but without the branch for processing the music symbols. 

Thus, this workflow is used when the user has previosly classified the glyphs of the **_column-splitted_ music symbol layer** and wants to use these to continue the process of finding the pitch of these glyphs (by using the results of the column-splitted staff layer) and then encoding the image contents into an MEI file (integrating also the results of the column-splitted text layer in the `MEI Encoding` job). An example of a classified glyphs file for a **_column-splitted_ music symbol layer** can be found [here](https://github.com/ECHOES-from-the-Past/OMR_Portuguese_Sources/blob/main/resources/2_music_symbol_classification/Iberian_square_notation/Interactive%20Classifier%20-%20GameraXML%20-%20Classified%20Glyphs.xml) for book opening [f. 144-145](/resources/1_document_analysis/Iberian_square_notation/pixel_ground_truth_data/Image.png) of the Iberian square notation MS.034 source. 

**Workflow file:** [Classified_Glyphs_to_MEI_Encoding.json](./Classified_Glyphs_to_MEI_Encoding.json)

### Screenshot of workflow
![Classified_Glyphs_to_MEI_Encoding](./images/Classified_Glyphs_to_MEI_Encoding.png)

